<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets">

    <!--
    Page Purpose:
    1. Displays full details of the selected movie, including image, title, description, release date, rating, and availability.
    2. Allows users to borrow the movie (if allowed), close the modal, add a review, or view existing reviews.
    3. Shows validation and system messages in the context of the selected movie.
    -->

    <h:panelGroup rendered="#{pageController.currentPage eq 'movieDetails'}">
        <div class="modal-overlay">
            <div class="modal-dialog">

                <h:form>
                    <div class="movie-dialog-content">
                        <div class="poster-section">
                            <h:graphicImage value="#{movieBean.getMovieImageBase64(movieBean.selectedMovie.movieId)}"
                                            styleClass="modal-poster"/>
                        </div>

                        <div class="info-section">
                            <!-- üîπ Display messages -->
                            <h:messages globalOnly="true"
                                        showDetail="true"
                                        errorClass="error-message"
                                        infoClass="success-message"
                                        warnClass="warning-message"
                                        fatalClass="fatal-message" />


                            <h2 class="movie-title">#{movieBean.selectedMovie.title}</h2>

                            <p>
                                <span class="label">üìÖ </span>
                                <h:outputText value="#{movieBean.selectedMovie.dateRelease}">
                                    <f:convertDateTime pattern="yyyy-MM-dd"/>
                                </h:outputText>
                            </p>

                            <p class="stars">
                                <span class="label">‚≠ê</span>
                                <ui:repeat value="#{reviewBean.getStarList(reviewBean.getAverageRatingForMovie(movieBean.selectedMovie.movieId))}" var="full">
                                    <h:outputText value="#{full ? '‚òÖ' : '‚òÜ'}" styleClass="rating-star" />
                                </ui:repeat>
                                (#{reviewBean.getAverageRatingForMovie(movieBean.selectedMovie.movieId)})
                            </p>

                            <p>#{movieBean.selectedMovie.description}</p>
                            <p><b>Available:</b> #{movieBean.selectedMovie.copiesAvailable}</p>

                            <div class="dialog-buttons">
                                <h:outputText value="üéØ You can borrow #{borrowBean.remainingBorrowLimit} more"
                                              rendered="#{borrowBean.canUserBorrow()}"
                                              styleClass="remaining-borrow-info" />

                                <h:commandButton value="üéü Borrow"
                                                 action="#{borrowBean.borrowMovie(movieBean.selectedMovie.movieId)}"
                                                 rendered="#{borrowBean.canUserBorrow()}"
                                                 styleClass="action-btn"
                                                 onclick="return confirm('Are you sure you want to borrow this movie?');">
                                    <f:ajax execute="@form" render="@all" />
                                </h:commandButton>

                                <h:outputText rendered="#{!borrowBean.canUserBorrow()}"
                                              value="‚ùå You have reached your borrowing limit"
                                              styleClass="limit-reached" />

                                <h:commandButton value="‚úñ Close"
                                                 action="#{pageController.setPage('home')}"
                                                 styleClass="close-btn">
                                    <f:ajax execute="@this" render="@all"/>
                                </h:commandButton>

                                <h:commandButton value="‚ûï Add Review"
                                                 action="#{pageController.setPage('addReview')}"
                                                 rendered="#{userBean.loggedInUser != null}"
                                                 styleClass="action-btn" />

                                <h:commandButton value="üìù View Reviews"
                                                 action="#{reviewBean.loadSelectedMovieReviews}"
                                                 styleClass="secondary-btn">
                                    <f:param name="movieId" value="#{movieBean.selectedMovie.movieId}" />
                                </h:commandButton>

                            </div>
                        </div>
                    </div>
                </h:form>

            </div>
        </div>
    </h:panelGroup>
</ui:composition>
