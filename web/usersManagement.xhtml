<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:ui="http://java.sun.com/jsf/facelets">

    <!--
    Page Purpose:
    1. Displays a table of all registered users with relevant information (ID, name, email, role, registration date).
    2. Allows the admin to change user roles, delete users, or view their borrowing history.
    3. Provides a button to return to the admin dashboard.
    -->

    <h:panelGroup rendered="#{pageController.currentPage eq 'usersManagement'}">
        <h:form>

            <h2 class="page-title">ðŸ‘¥ Users Management</h2>

            <!-- Load users if needed -->
            #{userBean.ensureUsersLoaded()}

            <!-- Back button -->
            <h:commandButton value="â¬…ï¸ Back to Dashboard"
                             action="#{pageController.setPage('admin')}"
                             styleClass="action-btn">
                <f:ajax execute="@form" render="@all"/>
            </h:commandButton>

            <br/><br/>

            <!-- Users table -->
            <h:dataTable value="#{userBean.users}" var="user" styleClass="user-table">
                <h:column>
                    <f:facet name="header">User ID</f:facet>
                        #{user.userId}
                </h:column>
                <h:column>
                    <f:facet name="header">Name</f:facet>
                        #{user.name}
                </h:column>
                <h:column>
                    <f:facet name="header">Email</f:facet>
                        #{user.email}
                </h:column>
                <h:column>
                    <f:facet name="header">Role</f:facet>
                        #{user.role}
                </h:column>
                <h:column>
                    <f:facet name="header">Registration Date</f:facet>
                    <h:outputText value="#{user.dateRegistration}">
                        <f:convertDateTime pattern="yyyy-MM-dd"/>
                    </h:outputText>
                </h:column>

                <h:column>
                    <f:facet name="header">Actions</f:facet>

                    <!-- Change Role -->
                    <h:commandButton value="Change Role"
                                     rendered="#{user.role eq 'USER'}"
                                     action="#{userBean.toggleUserRole(user.userId)}"
                                     styleClass="action-btn"
                                     onclick="return confirm('Are you sure you want to change this user\'s role?');">
                        <f:ajax execute="@this" render="@all"/>
                    </h:commandButton>

                    <!-- Delete User -->
                    <h:commandButton value="Delete"
                                     rendered="#{user.role eq 'USER'}"
                                     action="#{userBean.deleteUser(user.userId)}"
                                     styleClass="action-btn"
                                     onclick="return confirm('Are you sure you want to delete this user?');">
                        <f:ajax execute="@this" render="@all"/>
                    </h:commandButton>

                    <!-- View Borrowing History -->
                    <h:commandButton value="History"
                                     action="#{userBean.viewUserBorrowingHistory(user.userId)}"
                                     styleClass="action-btn">
                        <f:ajax execute="@this" render="@all"/>
                    </h:commandButton>
                </h:column>
            </h:dataTable>
        </h:form>
    </h:panelGroup>
</ui:composition>
